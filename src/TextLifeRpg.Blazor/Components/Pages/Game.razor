@page "/game"
@using TextLifeRpg.Application.Abstraction
@inject GameSaveStore GameSaveStore
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IDialogueService DialogueService

@rendermode InteractiveServer

@if (_isLoading)
{
  <div class="trpg-layout-page">
    <p class="animate-pulse text-gray-500">Loading game...</p>
  </div>
}
else if (GameSaveStore.CurrentSave is null)
{
  <div class="trpg-layout-page">
    <p>No game loaded. Go to main menu.</p>
    <NavLink href="/" class="trpg-btn">Main Menu</NavLink>
  </div>
}
else
{
  <div class="grid min-h-screen grid-cols-12">

    @if (_showSaveToast)
    {
      <ToastNotification Message="Game saved!"/>
    }

    <div class="col-span-2 bg-slate-200">
      <LeftGameSidebar OnSaveLoaded="OnSaveLoaded" OnPlayerCharacterClicked="OpenCharacterDetails"
                       OnSaveCompleted="ShowSaveToastAsync"/>
    </div>

    <div class="col-span-8">
      <div class="flex h-screen flex-col">
        <div class="flex flex-grow flex-col gap-4 overflow-auto p-6" @ref="_textZoneRef">
          @foreach (var textLine in GameSaveStore.CurrentSave.TextLines)
          {
            <p>
              @foreach (var part in textLine.TextParts)
              {
                <span class="@(part.Color.HasValue ? part.Color.Value.ToTailwindClass() : "")">
                  @part.Text
                </span>
              }
            </p>
          }
        </div>

        @if (GameSaveStore.CurrentSave.NpcInteractionType == NpcInteractionType.Dialogue)
        {
          <div class="bg-slate-100">
            <DialogueOptionsPanel/>
          </div>
        }
        else
        {
          <div class="bg-slate-100">
            <ExplorationActionsPanel/>
          </div>
          <div class="bg-slate-100">
            <MovementPanel/>
          </div>
        }
      </div>

    </div>

    <div class="col-span-2 bg-slate-200">
      <RightGameSidebar OnNpcClicked="OpenCharacterDetails" OnNpcRightClicked="StartDialogueAsync"/>
    </div>

  </div>
}

@code {
  private bool _isLoading = true;
  private ElementReference _textZoneRef;
  private bool _showSaveToast;

  /// <summary>
  /// Registers for game state changes and initializes location display.
  /// </summary>
  protected override async Task OnInitializedAsync()
  {
    GameSaveStore.OnAsyncChange += HandleGameSaveChanged;

    await Task.Delay(10);

    _isLoading = false;
    StateHasChanged();
  }

  private Task HandleGameSaveChanged()
  {
    StateHasChanged();
    return Task.CompletedTask;
  }

  /// <summary>
  /// Callback triggered when a save is loaded from sidebar.
  /// </summary>
  private void OnSaveLoaded()
  {
    Navigation.NavigateTo("/game");
    StateHasChanged();
  }

  /// <summary>
  /// Navigates to the character details page.
  /// </summary>
  private void OpenCharacterDetails(Character character)
  {
    Navigation.NavigateTo($"/characterdetails/{character.Id}");
    StateHasChanged();
  }

  private async Task StartDialogueAsync(Character character)
  {
    var gameSave = GameSaveStore.CurrentSave!;
    gameSave.StartDialogue(character.Id);
    try
    {
      await DialogueService.ExecuteGreetingAsync(gameSave, CancellationToken.None);
      await GameSaveStore.NotifyStateChangedAsync();
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Failed to start dialogue: {ex.Message}");
    }
  }

  /// <summary>
  /// Scrolls the text output area to the bottom after render.
  /// </summary>
  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (_textZoneRef.Context != null)
    {
      await ScrollTextZoneToBottomAsync();
    }
  }

  /// <summary>
  /// Invokes JavaScript to scroll the text zone to the bottom.
  /// </summary>
  private async Task ScrollTextZoneToBottomAsync()
  {
    await JS.InvokeVoidAsync("scrollToBottom", _textZoneRef);
  }

  public async Task ShowSaveToastAsync()
  {
    _showSaveToast = true;
    StateHasChanged();
    await Task.Delay(1100);
    _showSaveToast = false;
    StateHasChanged();
  }

}
